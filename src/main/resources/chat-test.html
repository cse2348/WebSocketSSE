<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>WebSocket(STOMP) 테스트</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; }
        input, button { padding: 8px; margin: 4px 0; }
        #log { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; height: 300px; overflow: auto; background: #f9f9f9; }
        .row { display:flex; gap:8px; align-items:center; }
        .row > input { flex: 1 }
    </style>
    <!-- STOMP 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket(STOMP) 채팅 테스트</h2>

<div class="row">
    <label style="width:110px">서버</label>
    <input id="base" value="https://backendteamb.site">
</div>
<div class="row">
    <label style="width:110px">JWT 토큰</label>
    <input id="token" placeholder="로그인 응답의 token 붙여넣기">
</div>
<div class="row">
    <label style="width:110px">방 ID</label>
    <input id="roomId" value="1">
</div>

<div class="row">
    <button id="btnConnect">연결하기</button>
    <button id="btnSubscribe" disabled>구독하기</button>
    <button id="btnDisconnect" disabled>끊기</button>
</div>

<div class="row">
    <input id="message" placeholder="메시지 입력 (Enter로 전송)">
    <button id="btnSend" disabled>보내기</button>
</div>

<h3>로그</h3>
<div id="log"></div>

<script>
    let stompClient = null;
    const $ = (id) => document.getElementById(id);
    const log = (msg) => {
        const el = $("log");
        el.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        el.scrollTop = el.scrollHeight;
    };

    const buildWsUrl = (base) => {
        const url = new URL(base);
        if (url.protocol === "https:") return "wss://" + url.host + "/ws/chat";
        if (url.protocol === "http:")  return "ws://"  + url.host + "/ws/chat";
        throw new Error("URL은 http:// 또는 https:// 이어야 합니다.");
    };

    $("btnConnect").onclick = () => {
        const base = $("base").value.trim();
        const token = $("token").value.trim();
        if (!token) { alert("JWT 토큰을 입력하세요 (/auth/login 응답)"); return; }

        let wsUrl;
        try { wsUrl = buildWsUrl(base); }
        catch { alert("서버 주소가 잘못되었습니다. (예: https://backendteamb.site)"); return; }

        log(`웹소켓 연결 시도 → ${wsUrl}`);
        const sock = new WebSocket(wsUrl);
        stompClient = Stomp.over(sock);

        // STOMP 디버그 로그
        stompClient.debug = (s) => log("[STOMP DEBUG] " + s);

        stompClient.connect(
            { Authorization: "Bearer " + token }, // CONNECT 헤더
            frame => {
                log("연결 성공: " + frame.command + " " + JSON.stringify(frame.headers));
                $("btnSubscribe").disabled = false;
                $("btnDisconnect").disabled = false;

                // (선택) 서버에서 @MessageExceptionHandler로 내려주는 에러 큐 구독
                try {
                    stompClient.subscribe("/user/queue/errors", (msg) => {
                        log("서버 에러: " + msg.body);
                    });
                } catch (_) {}
            },
            err => {
                log("연결 실패: " + err);
            }
        );
    };

    $("btnSubscribe").onclick = () => {
        const roomId = $("roomId").value.trim();
        if (!stompClient || !stompClient.connected) return alert("먼저 연결하세요");
        const topic = "/topic/chat/" + roomId;

        stompClient.subscribe(topic, (msg) => {
            // 수신 메시지 예쁘게 출력 (JSON 파싱 우선)
            try {
                const data = JSON.parse(msg.body);
                log(`수신: content="${data.content}" senderId=${data.senderId} roomId=${data.roomId} id=${data.id ?? "-"} at=${data.createdAt ?? "-"}`);
            } catch {
                log("수신(raw): " + msg.body);
            }
        });

        log("구독 요청: " + topic);
        $("btnSend").disabled = false;
    };

    $("btnSend").onclick = () => {
        const roomId = $("roomId").value.trim();
        const text = $("message").value;
        if (!stompClient || !stompClient.connected) return alert("먼저 연결하세요");
        if (!text || !text.trim()) { alert("메시지를 입력하세요"); return; }

        const payload = { content: text.trim() };

        // ★ 핵심: content-type을 application/json으로 지정
        stompClient.send(
            `/app/chat/${roomId}/send`,
            { "content-type": "application/json" },
            JSON.stringify(payload)
        );

        log("전송: " + JSON.stringify(payload));
        $("message").value = "";
    };

    $("btnDisconnect").onclick = () => {
        if (stompClient) {
            stompClient.disconnect(() => log("연결 해제 완료"));
        }
        $("btnSubscribe").disabled = true;
        $("btnSend").disabled = true;
        $("btnDisconnect").disabled = true;
    };

    // Enter로 전송
    $("message").addEventListener("keydown", (e) => {
        if (e.key === "Enter") $("btnSend").click();
    });
</script>
</body>
</html>
