<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8"/>
    <title>WebSocket(STOMP) í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: system-ui, sans-serif; max-width: 720px; margin: 24px auto; }
        input, button { padding: 8px; margin: 4px 0; }
        #log { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; height: 280px; overflow: auto; }
        .row { display:flex; gap:8px; align-items:center; }
        .row > input { flex: 1 }
    </style>
    <!-- CDN: STOMP -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket(STOMP) ì±„íŒ… í…ŒìŠ¤íŠ¸ (ë„¤ì´í‹°ë¸Œ WebSocket)</h2>

<div class="row">
    <label style="width:110px">ì„œë²„</label>
    <input id="base" value="https://backendteamb.site">
</div>
<div class="row">
    <label style="width:110px">JWT í† í°</label>
    <input id="token" placeholder="ë¡œê·¸ì¸ ì‘ë‹µì˜ token ë¶™ì—¬ë„£ê¸°">
</div>
<div class="row">
    <label style="width:110px">ë°© ID</label>
    <input id="roomId" value="1">
</div>

<div class="row">
    <button id="btnConnect">ì—°ê²°í•˜ê¸°</button>
    <button id="btnSubscribe" disabled>êµ¬ë…í•˜ê¸°</button>
    <button id="btnDisconnect" disabled>ëŠê¸°</button>
</div>

<div class="row">
    <input id="message" placeholder="ë©”ì‹œì§€ ì…ë ¥">
    <button id="btnSend" disabled>ë³´ë‚´ê¸°</button>
</div>

<h3>ë¡œê·¸</h3>
<div id="log"></div>

<script>
    let stompClient = null;
    const $ = (id) => document.getElementById(id);
    const log = (msg) => { const el = $("log"); el.textContent += msg + "\n"; el.scrollTop = el.scrollHeight; };

    $("btnConnect").onclick = () => {
        const base = $("base").value.trim();
        const token = $("token").value.trim();
        if (!token) { alert("JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš” (/auth/login ì‘ë‹µ)"); return; }

        // ë„¤ì´í‹°ë¸Œ WebSocket URL ìƒì„± (http â†’ ws, https â†’ wss)
        const wsUrl = base.replace(/^http/, "ws") + "/ws/chat";

        const sock = new WebSocket(wsUrl);
        stompClient = Stomp.over(sock);
        stompClient.debug = (s) => log(s);

        // CONNECT í—¤ë”ì— JWT ë„£ê¸°
        stompClient.connect(
            { Authorization: "Bearer " + token }, // í—¤ë” ì „ë‹¬
            frame => {
                log("ğŸŸ¢ ì—°ê²°ë¨: " + frame);
                $("btnSubscribe").disabled = false;
                $("btnDisconnect").disabled = false;
            },
            err => { log("ì—°ê²° ì‹¤íŒ¨: " + err); }
        );
    };

    $("btnSubscribe").onclick = () => {
        const roomId = $("roomId").value.trim();
        if (!stompClient || !stompClient.connected) return alert("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”");
        const topic = "/topic/chat/" + roomId;
        stompClient.subscribe(topic, (msg) => {
            log("ìˆ˜ì‹ : " + msg.body);
        });
        log("êµ¬ë…: " + topic);
        $("btnSend").disabled = false;
    };

    $("btnSend").onclick = () => {
        const roomId = Number($("roomId").value.trim());
        const text = $("message").value;
        if (!stompClient || !stompClient.connected) return alert("ë¨¼ì € ì—°ê²°í•˜ì„¸ìš”");
        const payload = { roomId, content: text };
        stompClient.send("/app/chat.send", {}, JSON.stringify(payload));
        log("ì „ì†¡: " + JSON.stringify(payload));
        $("message").value = "";
    };

    $("btnDisconnect").onclick = () => {
        if (stompClient) stompClient.disconnect(() => log("ì—°ê²° í•´ì œ"));
        $("btnSubscribe").disabled = true;
        $("btnSend").disabled = true;
        $("btnDisconnect").disabled = true;
    };
</script>
</body>
</html>
